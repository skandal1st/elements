# =============================================================================
# Elements Platform - Полная конфигурация
# =============================================================================
# Использование:
#   docker-compose up -d              # Запустить все сервисы
#   docker-compose up -d postgres     # Только PostgreSQL
#   docker-compose logs -f backend-hr # Логи HR backend
# =============================================================================

services:
  # ===========================================================================
  # Базы данных и инфраструктура
  # ===========================================================================

  postgres:
    image: postgres:14-alpine
    container_name: elements-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-elements}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-elements}
      POSTGRES_DB: ${POSTGRES_DB:-elements}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U elements -d elements"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: elements-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: elements-rabbitmq
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-elements}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-elements}
    ports:
      - "5672:5672" # AMQP
      - "15672:15672" # Management UI
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_running"]
      interval: 30s
      timeout: 10s
      retries: 5

  minio:
    image: minio/minio:latest
    container_name: elements-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-elements}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-elements123}
    ports:
      - "9000:9000" # API
      - "9001:9001" # Console
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ===========================================================================
  # Elements HR (Python/FastAPI)
  # ===========================================================================

  backend-hr:
    build:
      context: ./HR_desk/backend
      dockerfile: Dockerfile
    container_name: elements-hr-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      # Database
      - DATABASE_URL=postgresql://${POSTGRES_USER:-elements}:${POSTGRES_PASSWORD:-elements}@postgres:5432/${POSTGRES_DB:-elements}

      # Auth (общий секрет для всех модулей)
      - SECRET_KEY=${JWT_SECRET:-elements-super-secret-key-change-in-production}

      # SupporIT integration
      - SUPPORIT_API_URL=http://backend-it:3001/api
      - SUPPORIT_TOKEN=${SUPPORIT_TOKEN:-}

      # Active Directory
      - AD_SERVER=${AD_SERVER:-}
      - AD_USER=${AD_USER:-}
      - AD_PASSWORD=${AD_PASSWORD:-}
      - AD_BASE_DN=${AD_BASE_DN:-}
      - AD_DOMAIN=${AD_DOMAIN:-}
      - AD_USE_SSL=${AD_USE_SSL:-true}

      # Mailcow
      - MAILCOW_API_URL=${MAILCOW_API_URL:-}
      - MAILCOW_API_KEY=${MAILCOW_API_KEY:-}

      # 1C ZUP
      - ZUP_API_URL=${ZUP_API_URL:-}
      - ZUP_USERNAME=${ZUP_USERNAME:-}
      - ZUP_PASSWORD=${ZUP_PASSWORD:-}

      # RabbitMQ
      - RABBITMQ_URL=amqp://${RABBITMQ_USER:-elements}:${RABBITMQ_PASSWORD:-elements}@rabbitmq:5672/

      # Redis
      - REDIS_URL=redis://redis:6379/0

      # Seed admin
      - SEED_ADMIN_ENABLED=${SEED_ADMIN_ENABLED:-true}
      - SEED_ADMIN_EMAIL=${SEED_ADMIN_EMAIL:-admin@elements.local}
      - SEED_ADMIN_PASSWORD=${SEED_ADMIN_PASSWORD:-admin123}
      - SEED_ADMIN_ROLE=admin
    volumes:
      - hr_uploads:/app/uploads
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  frontend-hr:
    build:
      context: ./HR_desk/frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_BASE=/api/v1
    container_name: elements-hr-frontend
    restart: unless-stopped
    ports:
      - "8080:80"
    depends_on:
      - backend-hr

  # ===========================================================================
  # Elements IT / SupporIT (Node.js/Express)
  # ===========================================================================

  backend-it:
    build:
      context: ./supporit/server
      dockerfile: Dockerfile
    container_name: elements-it-backend
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      # Database
      - DATABASE_URL=postgresql://${POSTGRES_USER:-elements}:${POSTGRES_PASSWORD:-elements}@postgres:5432/${POSTGRES_DB:-elements}

      # Auth
      - JWT_SECRET=${JWT_SECRET:-elements-super-secret-key-change-in-production}
      - JWT_EXPIRES_IN=604800

      # Server
      - PORT=3001
      - NODE_ENV=production
      - CORS_ORIGIN=*

      # Encryption
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:-0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef}

      # Uploads
      - UPLOAD_DIR=/app/uploads

      # Telegram (optional)
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_BOT_ENABLED=${TELEGRAM_BOT_ENABLED:-false}

      # Email IMAP (optional)
      - IMAP_HOST=${IMAP_HOST:-}
      - IMAP_PORT=${IMAP_PORT:-993}
      - IMAP_USER=${IMAP_USER:-}
      - IMAP_PASSWORD=${IMAP_PASSWORD:-}
      - IMAP_TLS=${IMAP_TLS:-true}

      # Email SMTP (optional)
      - SMTP_HOST=${SMTP_HOST:-}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-}
      - SMTP_SECURE=${SMTP_SECURE:-false}
      - FROM_EMAIL=${FROM_EMAIL:-}
      - FROM_NAME=${FROM_NAME:-SupporIT}
      - EMAIL_RECEIVER_ENABLED=${EMAIL_RECEIVER_ENABLED:-false}
      - SMTP_ENABLED=${SMTP_ENABLED:-false}

      # Zabbix (optional)
      - ZABBIX_URL=${ZABBIX_URL:-}
      - ZABBIX_API_TOKEN=${ZABBIX_API_TOKEN:-}
      - ZABBIX_ENABLED=${ZABBIX_ENABLED:-false}

      # HR_desk integration
      - HR_DESK_API_TOKEN=${HR_DESK_API_TOKEN:-}
      - INTEGRATION_API_TOKEN=${INTEGRATION_API_TOKEN:-}
    volumes:
      - it_uploads:/app/uploads
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test:
        ["CMD", "wget", "--spider", "-q", "http://localhost:3001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  frontend-it:
    build:
      context: ./supporit
      dockerfile: Dockerfile
      args:
        - VITE_API_BASE=/api
    container_name: elements-it-frontend
    restart: unless-stopped
    ports:
      - "8081:80"
    depends_on:
      - backend-it

volumes:
  postgres_data:
    name: elements_postgres_data
  redis_data:
    name: elements_redis_data
  rabbitmq_data:
    name: elements_rabbitmq_data
  minio_data:
    name: elements_minio_data
  hr_uploads:
    name: elements_hr_uploads
  it_uploads:
    name: elements_it_uploads

networks:
  default:
    name: elements_network
